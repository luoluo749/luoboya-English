<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è‰¾å®¾æµ©æ–¯10æ¬¡å¤ä¹ è®¡åˆ’ç”Ÿæˆå™¨</title>
    <style>
        body { font-family: å¾®è½¯é›…é»‘; padding: 20px; background-color: #f9f3e9; margin: 0; }
        .box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ddd; max-width: 800px; margin: 0 auto; }
        h1 { color: #e67e22; text-align: center; font-size: 24px; margin-top: 0; }
        .today-review { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107; }
        .today-title { color: #856404; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .today-item { color: #721c24; margin: 5px 0; font-size: 15px; }
        .no-today { color: #6c757d; font-size: 14px; }
        .input-area { margin: 20px 0; padding: 15px; background: #fef5e7; border-radius: 8px; }
        input, textarea { padding: 10px; margin: 10px 5px; border: 2px solid #e67e22; border-radius: 5px; box-sizing: border-box; }
        #courseName { width: 250px; }
        #startDate { width: 180px; }
        #wordList { width: 95%; height: 120px; resize: none; }
        button { padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; transition: background 0.3s; }
        button:hover { background: #d35400; }
        .plan-item { margin: 15px 0; padding: 15px; background: #fef5e7; border-radius: 8px; border-left: 4px solid #e67e22; }
        .review-day { margin: 6px 0; color: #333; font-size: 14px; }
        .title { color: #e67e22; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .tip { color: #666; font-size: 13px; margin-top: 10px; }
        .load-status { text-align: center; color: #6c757d; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="box">
        <h1>ğŸ“š è‰¾å®¾æµ©æ–¯10æ¬¡å¤ä¹ è®¡åˆ’ç”Ÿæˆå™¨</h1>

        <!-- ä»Šæ—¥å¤ä¹ åŒº -->
        <div class="today-review">
            <div class="today-title">ğŸ“… ä»Šå¤©ï¼ˆ<span id="localToday"></span>ï¼‰è¦å¤ä¹ çš„å†…å®¹ï¼š</div>
            <div id="todayReviewList" class="no-today">æ­£åœ¨åŠ è½½æœåŠ¡å™¨è¯¾ç¨‹...</div>
        </div>

        <!-- 1. æ‰‹åŠ¨æ·»åŠ è¯¾ç¨‹åŒºï¼ˆä¿ç•™ï¼‰ -->
        <div class="input-area">
            <h3>1. æ‰‹åŠ¨æ·»åŠ æ–°è¯¾ç¨‹</h3>
            <p>è¯¾ç¨‹åï¼š<input type="text" id="courseName" placeholder="å¦‚ï¼šäº”å¹´çº§æ•°å­¦ç¬¬ä¸€ç« " required></p>
            <p>å¼€å§‹æ—¥æœŸï¼š<input type="date" id="startDate" required></p>
            <p>å•è¯/çŸ¥è¯†ç‚¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šå†…å®¹ è§£é‡Šï¼‰ï¼š<br>
                <textarea id="wordList" placeholder="ä¾‹ï¼šåŠ æ³•äº¤æ¢å¾‹ a+b=b+a&#10;å¹³è¡Œå››è¾¹å½¢ ä¸¤ç»„å¯¹è¾¹åˆ†åˆ«å¹³è¡Œçš„å››è¾¹å½¢"></textarea>
            </p>
            <button onclick="addManualCourse()">æ·»åŠ è¯¾ç¨‹å¹¶ç”Ÿæˆè®¡åˆ’</button>
            <button onclick="clearManualInput()">æ¸…ç©ºè¾“å…¥</button>
        </div>

        <!-- 2. æœåŠ¡å™¨è¯¾ç¨‹åŠ è½½çŠ¶æ€ -->
        <div class="load-status" id="serverLoadStatus">æ­£åœ¨è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨è¯¾ç¨‹...</div>

        <!-- 3. æ‰€æœ‰è¯¾ç¨‹è®¡åˆ’å±•ç¤ºåŒºï¼ˆå«ä¸‹è½½TXTæŒ‰é’®ï¼‰ -->
        <div id="allPlans"></div>
    </div>

    <script>
        const reviewIntervals = [1, 2, 3, 5, 7, 9, 12, 14, 17, 21]; // 10æ¬¡å¤ä¹ é—´éš”ï¼ˆå¤©ï¼‰
        const SERVER_COURSE_DIR = "./course/"; // æœåŠ¡å™¨è¯¾ç¨‹æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå›ºå®šï¼‰
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = getLocalDateStr(today);
        let allCourses = []; // å­˜å‚¨æ‰€æœ‰è¯¾ç¨‹ï¼ˆæ‰‹åŠ¨æ·»åŠ  + æœåŠ¡å™¨åŠ è½½ï¼‰

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œï¼šæ˜¾ç¤ºä»Šæ—¥æ—¥æœŸ + è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨æ‰€æœ‰è¯¾ç¨‹
        window.onload = () => {
            document.getElementById('localToday').textContent = todayStr;
            document.getElementById('startDate').value = todayStr; // é»˜è®¤å¼€å§‹æ—¥æœŸä¸ºä»Šå¤©
            autoLoadServerCourses(); // è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨è¯¾ç¨‹
        };

        /** å·¥å…·å‡½æ•°ï¼šæ—¥æœŸæ ¼å¼åŒ–ï¼ˆYYYY-MM-DDï¼‰ */
        function getLocalDateStr(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        /** æ ¸å¿ƒ1ï¼šè‡ªåŠ¨åŠ è½½æœåŠ¡å™¨courseæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰TXTè¯¾ç¨‹ */
        function autoLoadServerCourses() {
            const loadStatus = document.getElementById('serverLoadStatus');
            
            // å…³é”®ï¼šè¯·æ±‚åç«¯æ¥å£è·å–courseæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰TXTæ–‡ä»¶åï¼ˆéœ€åç«¯é…åˆï¼‰
            // åç«¯éœ€æä¾›æ¥å£ï¼ˆå¦‚/getAllCourseFilesï¼‰ï¼Œè¿”å›æ ¼å¼ï¼š["æ•°å­¦.txt","è‹±è¯­.txt"]
            fetch('/getAllCourseFiles') 
                .then(res => {
                    if (!res.ok) throw new Error(`æ¥å£è¯·æ±‚å¤±è´¥ï¼ˆ${res.status}ï¼‰`);
                    return res.json();
                })
                .then(txtFileNames => {
                    if (txtFileNames.length === 0) {
                        loadStatus.textContent = "æœåŠ¡å™¨courseæ–‡ä»¶å¤¹ä¸‹æš‚æ— TXTè¯¾ç¨‹æ–‡ä»¶";
                        renderAllCourses(); // æ¸²æŸ“å·²æœ‰æ‰‹åŠ¨è¯¾ç¨‹ï¼ˆè‹¥æœ‰ï¼‰
                        return;
                    }

                    // æ‰¹é‡åŠ è½½æ¯ä¸ªTXTè¯¾ç¨‹
                    let loadedCount = 0;
                    txtFileNames.forEach(fileName => {
                        fetch(SERVER_COURSE_DIR + fileName)
                            .then(res => {
                                if (!res.ok) throw new Error(`æ–‡ä»¶${fileName}åŠ è½½å¤±è´¥`);
                                return res.text();
                            })
                            .then(txtContent => {
                                // è§£æTXTå†…å®¹ï¼ˆæŒ‰çº¦å®šæ ¼å¼ï¼šç¬¬1è¡Œè¯¾ç¨‹åï¼Œç¬¬2è¡Œå¼€å§‹æ—¥æœŸï¼Œç¬¬3è¡Œèµ·å†…å®¹ï¼‰
                                const lines = txtContent.split('\n').map(line => line.trim()).filter(line => line);
                                if (lines.length < 2) throw new Error(`æ–‡ä»¶${fileName}æ ¼å¼é”™è¯¯`);

                                // æå–è¯¾ç¨‹ä¿¡æ¯
                                const courseName = lines[0];
                                const startDate = lines[1];
                                if (!/^\d{4}-\d{2}-\d{2}$/.test(startDate)) throw new Error(`æ–‡ä»¶${fileName}æ—¥æœŸæ ¼å¼é”™è¯¯`);
                                
                                // æå–çŸ¥è¯†ç‚¹
                                const contents = [];
                                for (let i = 2; i < lines.length; i++) {
                                    const [content, ...descParts] = lines[i].split(' ');
                                    const desc = descParts.join(' ').trim();
                                    if (content && desc) contents.push({ content, desc });
                                }

                                // ç”Ÿæˆè¯¾ç¨‹è®¡åˆ’å¹¶åŠ å…¥åˆ—è¡¨ï¼ˆå»é‡ï¼šåŒæ–‡ä»¶åä¸é‡å¤åŠ ï¼‰
                                const course = {
                                    id: `server_${fileName}`, // æœåŠ¡å™¨è¯¾ç¨‹IDï¼ˆå«æ–‡ä»¶åï¼Œé¿å…é‡å¤ï¼‰
                                    type: 'server', // æ ‡è®°ä¸ºæœåŠ¡å™¨è¯¾ç¨‹
                                    fileName: fileName,
                                    name: courseName,
                                    startDate: startDate,
                                    contents: contents,
                                    reviews: getReviewDates(startDate) // ç”Ÿæˆ10æ¬¡å¤ä¹ æ—¥æœŸ
                                };

                                // å»é‡ï¼šè‹¥å·²åŠ è½½è¿‡è¯¥æ–‡ä»¶ï¼Œæ›¿æ¢ï¼›å¦åˆ™æ–°å¢
                                const existingIndex = allCourses.findIndex(c => c.id === course.id);
                                if (existingIndex > -1) {
                                    allCourses[existingIndex] = course;
                                } else {
                                    allCourses.push(course);
                                }

                                loadedCount++;
                                // æ‰€æœ‰æ–‡ä»¶åŠ è½½å®Œæˆåæ›´æ–°çŠ¶æ€å’Œæ¸²æŸ“
                                if (loadedCount === txtFileNames.length) {
                                    loadStatus.textContent = `å·²è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨${loadedCount}ä¸ªTXTè¯¾ç¨‹`;
                                    renderAllCourses();
                                }
                            })
                            .catch(err => {
                                loadStatus.textContent += ` | ${err.message}`;
                                loadedCount++;
                                if (loadedCount === txtFileNames.length) renderAllCourses();
                            });
                    });
                })
                .catch(err => {
                    loadStatus.textContent = `æœåŠ¡å™¨è¯¾ç¨‹åŠ è½½å¤±è´¥ï¼š${err.message}`;
                    renderAllCourses();
                });
        }

        /** æ ¸å¿ƒ2ï¼šæ‰‹åŠ¨æ·»åŠ è¯¾ç¨‹ */
        function addManualCourse() {
            const courseName = document.getElementById('courseName').value.trim();
            const startDate = document.getElementById('startDate').value;
            const wordListText = document.getElementById('wordList').value.trim();

            // éªŒè¯è¾“å…¥
            if (!courseName) { alert("è¯·è¾“å…¥è¯¾ç¨‹åï¼"); return; }
            if (!startDate) { alert("è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸï¼"); return; }

            // è§£ææ‰‹åŠ¨è¾“å…¥çš„çŸ¥è¯†ç‚¹
            const contents = [];
            if (wordListText) {
                const lines = wordListText.split('\n').map(line => line.trim()).filter(line => line);
                lines.forEach(line => {
                    const [content, ...descParts] = line.split(' ');
                    const desc = descParts.join(' ').trim();
                    if (content && desc) {
                        contents.push({ content, desc });
                    } else {
                        alert(`â€œ${line}â€æ ¼å¼é”™è¯¯ï¼Œéœ€æŒ‰â€œå†…å®¹ è§£é‡Šâ€å¡«å†™ï¼Œå·²è·³è¿‡è¯¥è¡Œ`);
                    }
                });
            }

            // ç”Ÿæˆæ‰‹åŠ¨è¯¾ç¨‹ï¼ˆIDç”¨æ—¶é—´æˆ³ï¼Œé¿å…é‡å¤ï¼‰
            const manualCourse = {
                id: `manual_${Date.now()}`, // æ‰‹åŠ¨è¯¾ç¨‹IDï¼ˆæ—¶é—´æˆ³ï¼‰
                type: 'manual', // æ ‡è®°ä¸ºæ‰‹åŠ¨è¯¾ç¨‹
                fileName: `${courseName}_${todayStr}.txt`, // ä¸‹è½½æ—¶çš„é»˜è®¤æ–‡ä»¶å
                name: courseName,
                startDate: startDate,
                contents: contents,
                reviews: getReviewDates(startDate) // ç”Ÿæˆ10æ¬¡å¤ä¹ æ—¥æœŸ
            };

            // æ·»åŠ åˆ°è¯¾ç¨‹åˆ—è¡¨å¹¶æ¸²æŸ“
            allCourses.unshift(manualCourse); // æ‰‹åŠ¨è¯¾ç¨‹æ”¾æœ€å‰é¢
            renderAllCourses();
            alert(`æˆåŠŸæ·»åŠ è¯¾ç¨‹ï¼š${courseName}`);
            clearManualInput(); // æ¸…ç©ºè¾“å…¥æ¡†
        }

        /** å·¥å…·å‡½æ•°ï¼šç”Ÿæˆ10æ¬¡å¤ä¹ æ—¥æœŸ */
        function getReviewDates(startDateStr) {
            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            return reviewIntervals.map((days, index) => {
                const reviewDate = new Date(startDate);
                reviewDate.setDate(reviewDate.getDate() + days);
                return {
                    times: index + 1,
                    date: getLocalDateStr(reviewDate),
                    interval: days
                };
            });
        }

        /** æ ¸å¿ƒ3ï¼šæ¸²æŸ“æ‰€æœ‰è¯¾ç¨‹ï¼ˆæ‰‹åŠ¨ + æœåŠ¡å™¨ï¼‰ */
        function renderAllCourses() {
            const allPlansContainer = document.getElementById('allPlans');
            allPlansContainer.innerHTML = "";

            if (allCourses.length === 0) {
                allPlansContainer.innerHTML = `<p class="no-today">æš‚æ— è¯¾ç¨‹ï¼Œå¯æ‰‹åŠ¨æ·»åŠ æˆ–åœ¨æœåŠ¡å™¨courseæ–‡ä»¶å¤¹æ”¾TXTè¯¾ç¨‹</p>`;
                updateTodayReview();
                return;
            }

            // éå†æ¸²æŸ“æ¯ä¸ªè¯¾ç¨‹
            allCourses.forEach(course => {
                const planItem = document.createElement("div");
                planItem.className = "plan-item";

                // æ¸²æŸ“è¯¾ç¨‹æ¥æºï¼ˆæœåŠ¡å™¨/æ‰‹åŠ¨ï¼‰
                const sourceTip = course.type === 'server' 
                    ? `ï¼ˆæ¥è‡ªæœåŠ¡å™¨ï¼š${course.fileName}ï¼‰` 
                    : `ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰`;

                // æ¸²æŸ“å¤ä¹ æ—¥æœŸï¼ˆæ ‡è®°ä»Šæ—¥/å·²è¿‡æœŸï¼‰
                let reviewHtml = "";
                course.reviews.forEach(review => {
                    const isToday = review.date === todayStr;
                    const isPast = new Date(review.date) < today;
                    const style = isToday ? "color:#e67e22;font-weight:bold" : (isPast ? "color:#6c757d;text-decoration:line-through" : "");
                    reviewHtml += `<div class="review-day"><span style="${style}">ç¬¬${review.times}æ¬¡ï¼š${review.date}</span>ï¼ˆè·å¼€å§‹ç¬¬${review.interval}å¤©ï¼‰</div>`;
                });

                // æ¸²æŸ“çŸ¥è¯†ç‚¹
                let contentHtml = "";
                if (course.contents.length > 0) {
                    contentHtml = `<div class="tip">çŸ¥è¯†ç‚¹ï¼ˆå…±${course.contents.length}ä¸ªï¼‰ï¼š<br>${course.contents.map(c => `â€¢ ${c.content} - ${c.desc}`).join('<br>')}</div>`;
                } else {
                    contentHtml = `<div class="tip">æœ¬è¯¾ç¨‹æš‚æ— çŸ¥è¯†ç‚¹</div>`;
                }

                // æ¸²æŸ“è¯¾ç¨‹å¡ç‰‡ï¼ˆå«ä¸‹è½½TXTæŒ‰é’®ï¼‰
                planItem.innerHTML = `
                    <div class="title">ğŸ“š ${course.name} ${sourceTip} | å¼€å§‹æ—¥æœŸï¼š${course.startDate}</div>
                    <div>${reviewHtml}</div>
                    ${contentHtml}
                    <button onclick="downloadCourseTxt('${course.id}')" style="margin-top:10px;">ä¸‹è½½æœ¬è¯¾ç¨‹TXTï¼ˆå¯ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰</button>
                `;
                allPlansContainer.appendChild(planItem);
            });

            // æ›´æ–°ä»Šæ—¥å¤ä¹ åˆ—è¡¨
            updateTodayReview();
        }

        /** æ ¸å¿ƒ4ï¼šä¸‹è½½è¯¾ç¨‹ä¸ºTXTï¼ˆä¾›ç”¨æˆ·ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰ */
        function downloadCourseTxt(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (!course) { alert("è¯¾ç¨‹ä¸å­˜åœ¨ï¼"); return; }

            // æŒ‰çº¦å®šæ ¼å¼ç”ŸæˆTXTå†…å®¹ï¼ˆç¡®ä¿ä¸Šä¼ åˆ°æœåŠ¡å™¨åèƒ½è¢«æ­£ç¡®è§£æï¼‰
            let txtContent = `=== è‰¾å®¾æµ©æ–¯å¤ä¹ è¯¾ç¨‹ - ${course.name} ===\n`;
            txtContent += `${course.name}\n`; // ç¬¬1è¡Œï¼šè¯¾ç¨‹å
            txtContent += `${course.startDate}\n`; // ç¬¬2è¡Œï¼šå¼€å§‹æ—¥æœŸ
            txtContent += `\n# çŸ¥è¯†ç‚¹åˆ—è¡¨ï¼ˆå…±${course.contents.length}ä¸ªï¼‰\n`;
            course.contents.forEach(item => {
                txtContent += `${item.content} ${item.desc}\n`; // ç¬¬3è¡Œèµ·ï¼šçŸ¥è¯†ç‚¹
            });

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([txtContent], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = course.fileName; // æ–‡ä»¶åï¼ˆæ‰‹åŠ¨è¯¾ç¨‹ï¼šè¯¾ç¨‹å+æ—¥æœŸï¼›æœåŠ¡å™¨è¯¾ç¨‹ï¼šåŸæ–‡ä»¶åï¼‰
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`å·²ä¸‹è½½TXTæ–‡ä»¶ï¼š${course.fileName}\nå¯ç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨courseæ–‡ä»¶å¤¹`);
        }

        /** è¾…åŠ©ï¼šæ¸…ç©ºæ‰‹åŠ¨è¾“å…¥æ¡† */
        function clearManualInput() {
            document.getElementById('courseName').value = "";
            document.getElementById('startDate').value = todayStr;
            document.getElementById('wordList').value = "";
        }

        /** è¾…åŠ©ï¼šæ›´æ–°ä»Šæ—¥å¤ä¹ åˆ—è¡¨ */
        function updateTodayReview() {
            const todayList = document.getElementById('todayReviewList');
            const todayNeedReview = allCourses.filter(course => 
                course.reviews.some(review => review.date === todayStr)
            );

            if (todayNeedReview.length === 0) {
                todayList.innerHTML = "ä»Šæ—¥æš‚æ— å¤ä¹ ä»»åŠ¡ï¼Œå¥½å¥½ä¼‘æ¯å§ï¼";
                todayList.className = "no-today";
                return;
            }

            todayList.className = "";
            let html = "";
            todayNeedReview.forEach(course => {
                const reviewTimes = course.reviews.find(r => r.date === todayStr).times;
                html += `<div class="today-item">â€¢ ${course.name}ï¼ˆç¬¬${reviewTimes}æ¬¡å¤ä¹ ï¼‰</div>`;
            });
            todayList.innerHTML = html;
        }
    </script>
</body>
</html>
