<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ä»Šæ—¥å¤ä¹ è®¡åˆ’ï¼ˆå¤šè¯¾ç¨‹å¤šTXTå¯¼å‡ºç‰ˆï¼‰</title>
    <style>
        body { font-family: å¾®è½¯é›…é»‘; padding: 20px; background-color: #f9f3e9; margin: 0; }
        .box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ddd; max-width: 800px; margin: 0 auto; }
        h1 { color: #e67e22; text-align: center; font-size: 24px; margin-top: 0; }
        .today-review { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107; }
        .today-title { color: #856404; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .today-item { color: #721c24; margin: 5px 0; font-size: 15px; }
        .no-today { color: #6c757d; font-size: 14px; }
        .input-area { margin: 20px 0; padding: 15px; background: #fef5e7; border-radius: 8px; }
        input, textarea { padding: 10px; margin: 10px 5px; border: 2px solid #e67e22; border-radius: 5px; box-sizing: border-box; }
        #planName { width: 300px; }
        #startDate { width: 200px; }
        #wordInput { width: 500px; height: 100px; resize: none; }
        button { padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; transition: background 0.3s; }
        button:hover { background: #d35400; }
        .plan-item { margin: 15px 0; padding: 15px; background: #fef5e7; border-radius: 8px; border-left: 4px solid #e67e22; }
        .review-day { margin: 6px 0; color: #333; font-size: 14px; }
        .title { color: #e67e22; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .tip { color: #666; font-size: 13px; margin-top: 10px; }
        .word-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px #ddd; margin: 10px 0; text-align: center; }
        .word-eng { font-size: 20px; font-weight: bold; color: #e67e22; }
        .word-cn { font-size: 16px; color: #666; margin: 5px 0; }
        .mastery-btn { margin: 0 8px; padding: 8px 15px; background: #3498db; }
        .mastery-btn:nth-child(2) { background: #e74c3c; }
        .mastery-btn:last-child { background: #6c757d; }
        .mastered { text-decoration: line-through; color: #28a745; }
        .unmastered { color: #dc3545; }
        /* å¼¹çª—æ ·å¼ */
        #wordReviewModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 1000; min-width: 300px; }
        /* å¯¼å‡ºé€‰æ‹©å¼¹çª— */
        #exportSelectModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 1000; min-width: 400px; max-height: 70vh; overflow-y: auto; }
        .export-plan-item { margin: 10px 0; padding: 10px; background: #fef5e7; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="box">
        <h1>ä»Šæ—¥å¤ä¹ +10æ¬¡è®¡åˆ’ï¼ˆå¤šTXTå¯¼å‡ºç‰ˆï¼‰</h1>

        <!-- ä»Šæ—¥å¤ä¹ åŒº -->
        <div class="today-review">
            <div class="today-title">ğŸ“… ä»Šå¤©ï¼ˆ<span id="localToday"></span>ï¼‰è¦å¤ä¹ çš„å†…å®¹ï¼š</div>
            <div id="todayReviewList" class="no-today">æ­£åœ¨åŠ è½½å¤ä¹ è®¡åˆ’...</div>
        </div>

        <!-- æ ¸å¿ƒæ“ä½œåŒº -->
        <div class="input-area">
            <h3>1. æ‰‹åŠ¨æ·»åŠ è¯¾ç¨‹è®¡åˆ’</h3>
            <p>è¯¾ç¨‹åç§°ï¼ˆå¦‚â€œäº”å¹´çº§æ•°å­¦ç¬¬1ç« â€ï¼‰ï¼š</p>
            <input type="text" id="planName" placeholder="å¿…å¡«ï¼šè¾“å…¥è¯¾ç¨‹å" required>
            <p>å¼€å§‹å­¦ä¹ æ—¥æœŸï¼š</p>
            <input type="date" id="startDate" required>
            <p>å•è¯ï¼ˆæ¯è¡Œ1ç»„ï¼šè‹±æ–‡+ç©ºæ ¼+ä¸­æ–‡ï¼Œæ— åˆ™ä¸å¡«ï¼‰ï¼š</p>
            <textarea id="wordInput" placeholder="ç¤ºä¾‹ï¼šapple è‹¹æœ&#10;banana é¦™è•‰"></textarea>
            <br>
            <button onclick="addNewPlan()">æ·»åŠ è®¡åˆ’ï¼ˆå•è¯å­˜æœ¬åœ°ï¼‰</button>

            <h3 style="margin-top: 20px;">2. å¯¼å‡ºTXTï¼ˆå¯é€‰æ‹©è¯¾ç¨‹ï¼‰</h3>
            <p class="tip">æç¤ºï¼šç‚¹å‡»åå¯é€‰æ‹©è¦å¯¼å‡ºçš„è¯¾ç¨‹</p>
            <button onclick="showExportSelectModal()">é€‰æ‹©è¯¾ç¨‹å¹¶å¯¼å‡ºTXT</button>
        </div>

        <!-- è¯¾ç¨‹è®¡åˆ’å±•ç¤ºåŒº -->
        <div id="allPlans"></div>

        <!-- å•è¯å¤ä¹ å¼¹çª—ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="wordReviewModal">
            <div class="word-card">
                <div class="word-eng" id="currentWordEng"></div>
                <div class="word-cn" id="currentWordCn"></div>
                <div class="tip" id="wordProgress"></div>
            </div>
            <button class="mastery-btn" onclick="recordMastery(true)">âœ… è®¤è¯†</button>
            <button class="mastery-btn" onclick="recordMastery(false)">âŒ ä¸è®¤è¯†</button>
            <button class="mastery-btn" onclick="closeWordModal()">å…³é—­</button>
        </div>

        <!-- å¯¼å‡ºé€‰æ‹©å¼¹çª—ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="exportSelectModal">
            <h2>é€‰æ‹©è¦å¯¼å‡ºçš„è¯¾ç¨‹</h2>
            <div id="exportPlanList"></div>
            <button onclick="exportSelectedPlans()">ç¡®è®¤å¯¼å‡º</button>
            <button onclick="closeExportModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // åŸºç¡€é…ç½®
        const reviewIntervals = [1, 2, 3, 5, 7, 9, 12, 14, 17, 21]; // 10æ¬¡å¤ä¹ é—´éš”ï¼ˆå›ºå®šï¼‰
        const PLAN_KEY = "reviewPlansWithLocalCache"; // æœ¬åœ°ç¼“å­˜é”®åï¼ˆåŠ¨æ€æ•°æ®å­˜è¿™é‡Œï¼‰
        const today = new Date();
        today.setHours(0, 0, 0, 0); // æ¸…é™¤æ—¶åˆ†ç§’ï¼Œç¡®ä¿æ—¥æœŸå¯¹æ¯”å‡†ç¡®
        const todayStr = getLocalDateStr(today);
        // å¤ä¹ å¼¹çª—çŠ¶æ€
        let currentReviewPlan = null;
        let currentWordIndex = 0;

        // 1. å·¥å…·å‡½æ•°ï¼šæ—¥æœŸæ ¼å¼åŒ–ï¼ˆYYYY-MM-DDï¼‰
        function getLocalDateStr(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        // 2. é¡µé¢åˆå§‹åŒ–ï¼šåŠ è½½æœ¬åœ°ç¼“å­˜çš„åŠ¨æ€æ•°æ®
        window.onload = () => {
            document.getElementById('localToday').textContent = todayStr;
            loadActivePlans(); // åªåŠ è½½æœªè¿‡æœŸçš„è®¡åˆ’
        };

        // 3. åŠŸèƒ½1ï¼šæ‰‹åŠ¨æ·»åŠ è¯¾ç¨‹è®¡åˆ’ï¼ˆåŠ¨æ€æ•°æ®å­˜æœ¬åœ°ç¼“å­˜ï¼‰
        function addNewPlan() {
            const planName = document.getElementById("planName").value.trim();
            const startDate = document.getElementById("startDate").value;
            const wordInput = document.getElementById("wordInput").value.trim();

            // åŸºç¡€æ ¡éªŒ
            if (!planName || !startDate) {
                alert("è¯¾ç¨‹åå’Œå¼€å§‹æ—¥æœŸä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            // è§£æå•è¯ï¼ˆä»…å­˜è‹±æ–‡+ä¸­æ–‡ï¼Œåˆå§‹çŠ¶æ€ä¸ºâ€œæœªå¤ä¹ â€ï¼Œå­˜æœ¬åœ°ï¼‰
            const words = [];
            if (wordInput) {
                wordInput.split('\n').forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    const [eng, ...cnParts] = line.split(' ');
                    const cn = cnParts.join(' ').trim();
                    if (eng && cn) {
                        words.push({ eng, cn, isMastered: null }); // isMasteredï¼šnullæœªå¤ä¹ /trueè®¤è¯†/falseä¸è®¤è¯†ï¼ˆä»…æœ¬åœ°ï¼‰
                    }
                });
            }

            // ç”Ÿæˆ10æ¬¡å¤ä¹ æ—¥æœŸï¼ˆé™æ€ï¼Œå¯¼å‡ºæ—¶ä¼šåŒ…å«ï¼‰
            const startDateObj = new Date(startDate);
            startDateObj.setHours(0, 0, 0, 0);
            const firstReviewDate = new Date(startDateObj);
            firstReviewDate.setDate(firstReviewDate.getDate() + 1); // ç¬¬ä¸€æ¬¡å¤ä¹ åœ¨å¼€å§‹æ—¥æœŸå1å¤©

            const newPlan = {
                id: Date.now(), // å”¯ä¸€IDï¼ˆé¿å…é‡å¤ï¼‰
                name: planName,
                startDate: startDate,
                reviews: reviewIntervals.map((interval, i) => {
                    const reviewDate = new Date(firstReviewDate);
                    reviewDate.setDate(reviewDate.getDate() + (i === 0 ? 0 : interval - reviewIntervals[i-1]));
                    return {
                        times: i + 1,
                        date: getLocalDateStr(reviewDate),
                        interval: interval,
                        wordMastery: [] // å¤ä¹ è®°å½•ï¼ˆä»…æœ¬åœ°ï¼Œä¸å¯¼å‡ºï¼‰
                    };
                }),
                words: words // å•è¯åˆ—è¡¨ï¼ˆå¯¼å‡ºæ—¶ä»…å«eng+cnï¼Œä¸å«isMasteredï¼‰
            };

            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            const allPlans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            allPlans.push(newPlan);
            localStorage.setItem(PLAN_KEY, JSON.stringify(allPlans));

            // åˆ·æ–°é¡µé¢å±•ç¤º
            loadActivePlans();
            clearInput();
            alert(`"${planName}"è®¡åˆ’æ·»åŠ æˆåŠŸï¼åŠ¨æ€æ•°æ®å·²å­˜æœ¬åœ°ç¼“å­˜`);
        }

        // 4. åŠŸèƒ½2ï¼šå•è¯å¤ä¹ ï¼ˆåŠ¨æ€çŠ¶æ€å­˜æœ¬åœ°ï¼Œä¸å¯¼å‡ºï¼‰
        function startWordReview(planId) {
            const allPlans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            currentReviewPlan = allPlans.find(p => p.id === planId);
            if (!currentReviewPlan || currentReviewPlan.words.length === 0) {
                alert("è¯¥è¯¾ç¨‹æ²¡æœ‰å•è¯å¯å¤ä¹ ï¼");
                return;
            }

            currentWordIndex = 0;
            showCurrentWord();
            document.getElementById("wordReviewModal").style.display = "block";
        }

        // è¾…åŠ©ï¼šå±•ç¤ºå½“å‰å¤ä¹ çš„å•è¯
        function showCurrentWord() {
            const words = currentReviewPlan.words;
            if (currentWordIndex >= words.length) {
                alert("æ‰€æœ‰å•è¯å¤ä¹ å®Œæ¯•ï¼åŠ¨æ€è®°å½•å·²å­˜æœ¬åœ°ï½");
                closeWordModal();
                return;
            }

            const currentWord = words[currentWordIndex];
            document.getElementById("currentWordEng").textContent = currentWord.eng;
            document.getElementById("currentWordCn").textContent = currentWord.cn;
            document.getElementById("wordProgress").textContent = `è¿›åº¦ï¼š${currentWordIndex + 1}/${words.length}`;
        }

        // è¾…åŠ©ï¼šè®°å½•å•è¯æŒæ¡çŠ¶æ€ï¼ˆå­˜æœ¬åœ°ï¼‰
        function recordMastery(isMastered) {
            const currentWord = currentReviewPlan.words[currentWordIndex];
            currentWord.isMastered = isMastered;

            // è®°å½•åˆ°ä»Šæ—¥å¤ä¹ è®°å½•ï¼ˆä»…æœ¬åœ°ï¼‰
            const todayReview = currentReviewPlan.reviews.find(r => r.date === todayStr);
            if (todayReview) {
                todayReview.wordMastery.push({
                    wordEng: currentWord.eng,
                    isMastered: isMastered,
                    reviewTime: new Date().toLocaleTimeString()
                });
            }

            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            const allPlans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            const planIndex = allPlans.findIndex(p => p.id === currentReviewPlan.id);
            if (planIndex !== -1) {
                allPlans[planIndex] = currentReviewPlan;
                localStorage.setItem(PLAN_KEY, JSON.stringify(allPlans));
            }

            // ä¸‹ä¸€ä¸ªå•è¯
            currentWordIndex++;
            showCurrentWord();
        }

        // è¾…åŠ©ï¼šå…³é—­å¤ä¹ å¼¹çª—
        function closeWordModal() {
            document.getElementById("wordReviewModal").style.display = "none";
            currentReviewPlan = null;
            currentWordIndex = 0;
            loadActivePlans(); // åˆ·æ–°è®¡åˆ’å±•ç¤ºï¼ˆæ›´æ–°æœ¬åœ°çŠ¶æ€ï¼‰
        }

        // 5. åŠŸèƒ½3ï¼šæ˜¾ç¤ºå¯¼å‡ºé€‰æ‹©å¼¹çª—
        function showExportSelectModal() {
            const allPlans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            const activePlans = allPlans.filter(plan => {
                const lastReviewDate = new Date(plan.reviews[plan.reviews.length - 1].date);
                return lastReviewDate >= today;
            });

            if (activePlans.length === 0) {
                alert("æ²¡æœ‰æœªè¿‡æœŸçš„è¯¾ç¨‹å¯å¯¼å‡ºï¼");
                return;
            }

            const exportPlanList = document.getElementById("exportPlanList");
            exportPlanList.innerHTML = "";

            // ç”Ÿæˆè¯¾ç¨‹é€‰æ‹©åˆ—è¡¨
            activePlans.forEach(plan => {
                const planItem = document.createElement("div");
                planItem.className = "export-plan-item";
                planItem.innerHTML = `
                    <input type="checkbox" id="export_${plan.id}" value="${plan.id}">
                    <label for="export_${plan.id}">${plan.name}ï¼ˆå¼€å§‹ï¼š${plan.startDate}ï¼‰</label>
                `;
                exportPlanList.appendChild(planItem);
            });

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById("exportSelectModal").style.display = "block";
        }

        // åŠŸèƒ½4ï¼šå¯¼å‡ºé€‰ä¸­çš„è¯¾ç¨‹
        function exportSelectedPlans() {
            const allPlans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            const checkboxes = document.querySelectorAll('#exportPlanList input[type="checkbox"]:checked');
            const selectedPlanIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedPlanIds.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯¾ç¨‹ï¼");
                return;
            }

            // å¯¼å‡ºæ¯ä¸ªé€‰ä¸­çš„è¯¾ç¨‹
            selectedPlanIds.forEach(planId => {
                const plan = allPlans.find(p => p.id === planId);
                if (!plan) return;

                // æ„å»ºTXTå†…å®¹
                let txtContent = `=== è¯¾ç¨‹åŸºç¡€ä¿¡æ¯ ===\n`;
                txtContent += `è¯¾ç¨‹åï¼š${plan.name}\n`;
                txtContent += `å¼€å§‹æ—¥æœŸï¼š${plan.startDate}\n`;
                txtContent += `æ€»å¤ä¹ æ¬¡æ•°ï¼š10æ¬¡ï¼ˆæŒ‰è‰¾å®¾æµ©æ–¯é—´éš”ï¼‰\n\n`;

                txtContent += `=== 10æ¬¡å¤ä¹ å®‰æ’ï¼ˆé™æ€è®¡åˆ’ï¼‰ ===\n`;
                plan.reviews.forEach(review => {
                    txtContent += `ç¬¬${review.times}æ¬¡å¤ä¹ ï¼š${review.date}ï¼ˆè·å¼€å§‹ç¬¬${review.interval}å¤©ï¼‰\n`;
                });

                txtContent += `\n=== å•è¯åˆ—è¡¨ï¼ˆä»…åŸºç¡€ä¿¡æ¯ï¼‰ ===\n`;
