<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è‰¾å®¾æµ©æ–¯10æ¬¡å¤ä¹ è®¡åˆ’ç”Ÿæˆå™¨</title>
    <style>
        body { font-family: å¾®è½¯é›…é»‘; padding: 20px; background-color: #f9f3e9; margin: 0; }
        .box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ddd; max-width: 800px; margin: 0 auto; }
        h1 { color: #e67e22; text-align: center; font-size: 24px; margin-top: 0; }
        .today-review { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107; }
        .today-title { color: #856404; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .today-item { color: #721c24; margin: 5px 0; font-size: 15px; }
        .no-today { color: #6c757d; font-size: 14px; }
        .input-area { margin: 20px 0; padding: 15px; background: #fef5e7; border-radius: 8px; }
        select, textarea { padding: 10px; margin: 10px 5px; border: 2px solid #e67e22; border-radius: 5px; box-sizing: border-box; }
        #courseFileSelect { width: 350px; }
        button { padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; transition: background 0.3s; }
        button:hover { background: #d35400; }
        .plan-item { margin: 15px 0; padding: 15px; background: #fef5e7; border-radius: 8px; border-left: 4px solid #e67e22; }
        .review-day { margin: 6px 0; color: #333; font-size: 14px; }
        .title { color: #e67e22; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .tip { color: #666; font-size: 13px; margin-top: 10px; }
        .file-tip { color: #999; font-size: 12px; margin: 5px 0 0 8px; }
    </style>
</head>
<body>
    <div class="box">
        <h1>ğŸ“š è‰¾å®¾æµ©æ–¯10æ¬¡å¤ä¹ è®¡åˆ’ç”Ÿæˆå™¨</h1>

        <!-- ä»Šæ—¥å¤ä¹ åŒº -->
        <div class="today-review">
            <div class="today-title">ğŸ“… ä»Šå¤©ï¼ˆ<span id="localToday"></span>ï¼‰è¦å¤ä¹ çš„å†…å®¹ï¼š</div>
            <div id="todayReviewList" class="no-today">æ­£åœ¨åŠ è½½è¯¾ç¨‹è®¡åˆ’...</div>
        </div>

        <!-- æ ¸å¿ƒæ“ä½œåŒºï¼ˆæ”¹ä¸ºé€‰æ‹©æœåŠ¡å™¨è¯¾ç¨‹æ–‡ä»¶ï¼‰ -->
        <div class="input-area">
            <h3>1. åŠ è½½æœåŠ¡å™¨è¯¾ç¨‹æ–‡ä»¶</h3>
            <p>é€‰æ‹©è¯¾ç¨‹æ–‡ä»¶ï¼ˆæ¥è‡ª ./course/ ç›®å½•ï¼‰ï¼š</p>
            <select id="courseFileSelect" required>
                <option value="">-- è¯·å…ˆåŠ è½½è¯¾ç¨‹æ–‡ä»¶åˆ—è¡¨ --</option>
            </select>
            <button onclick="loadCourseFiles()">åŠ è½½æœåŠ¡å™¨è¯¾ç¨‹åˆ—è¡¨</button>
            <p class="file-tip">æç¤ºï¼šæœåŠ¡å™¨ ./course/ ç›®å½•ä¸‹çš„TXTæ–‡ä»¶éœ€æŒ‰æ ¼å¼ç¼–å†™ï¼šç¬¬1è¡Œè¯¾ç¨‹åï¼Œç¬¬2è¡Œå¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ï¼Œç¬¬3è¡Œèµ·ä¸ºå•è¯ï¼ˆè‹±æ–‡ ä¸­æ–‡ï¼‰</p>
            <br>
            <button onclick="loadSelectedCourse()" disabled>åŠ è½½é€‰ä¸­è¯¾ç¨‹</button>
        </div>

        <!-- è¯¾ç¨‹è®¡åˆ’å±•ç¤ºåŒºï¼ˆå«å•è¯¾ç¨‹å¯¼å‡ºæŒ‰é’®ï¼‰ -->
        <div id="allPlans"></div>
    </div>

    <script>
        const reviewIntervals = [1, 2, 3, 5, 7, 9, 12, 14, 17, 21]; // 10æ¬¡å¤ä¹ é—´éš”ï¼ˆä»å¼€å§‹æ—¥ç®—èµ·ï¼‰
        const SERVER_COURSE_DIR = "./course/"; // æœåŠ¡å™¨è¯¾ç¨‹æ–‡ä»¶æ ¹ç›®å½•
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = getLocalDateStr(today);
        let currentCourses = []; // å­˜å‚¨å½“å‰åŠ è½½çš„è¯¾ç¨‹åˆ—è¡¨

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºä»Šæ—¥æ—¥æœŸ
        window.onload = () => {
            document.getElementById('localToday').textContent = todayStr;
            // åˆå§‹åŠ è½½æœåŠ¡å™¨è¯¾ç¨‹åˆ—è¡¨
            loadCourseFiles();
        };

        // æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
        function getLocalDateStr(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        /**
         * åŠ è½½æœåŠ¡å™¨ ./course/ ç›®å½•ä¸‹çš„æ‰€æœ‰TXTæ–‡ä»¶åˆ—è¡¨
         * æ³¨ï¼šéœ€åç«¯é…åˆè¿”å›æ–‡ä»¶åˆ—è¡¨ï¼ˆæ­¤å¤„æ¨¡æ‹Ÿé€»è¾‘ï¼Œå®é™…éœ€åç«¯æ¥å£æ”¯æŒï¼‰
         */
        function loadCourseFiles() {
            const selectElement = document.getElementById("courseFileSelect");
            const loadBtn = document.querySelector("button[onclick='loadSelectedCourse()']");
            
            // å®é™…é¡¹ç›®ä¸­ï¼Œéœ€æ›¿æ¢ä¸ºåç«¯æ¥å£è¯·æ±‚ï¼ˆå¦‚ /api/getCourseFilesï¼‰
            // æ­¤å¤„æ¨¡æ‹Ÿè·å–æœåŠ¡å™¨TXTæ–‡ä»¶åˆ—è¡¨ï¼ˆç¤ºä¾‹æ–‡ä»¶åï¼‰
            fetch(SERVER_COURSE_DIR + "fileList.json") // å‡è®¾åç«¯æä¾›æ–‡ä»¶åˆ—è¡¨JSON
                .then(res => {
                    if (!res.ok) throw new Error("æ— æ³•è·å–è¯¾ç¨‹æ–‡ä»¶åˆ—è¡¨");
                    return res.json();
                })
                .then(fileList => {
                    // è¿‡æ»¤å‡ºTXTæ–‡ä»¶
                    const txtFiles = fileList.filter(file => file.endsWith(".txt"));
                    if (txtFiles.length === 0) {
                        selectElement.innerHTML = "<option value=''>-- æœåŠ¡å™¨ç›®å½•ä¸‹æ— TXTè¯¾ç¨‹æ–‡ä»¶ --</option>";
                        loadBtn.disabled = true;
                        return;
                    }

                    // å¡«å……ä¸‹æ‹‰æ¡†
                    selectElement.innerHTML = "<option value=''>-- è¯·é€‰æ‹©è¯¾ç¨‹æ–‡ä»¶ --</option>";
                    txtFiles.forEach(file => {
                        const option = document.createElement("option");
                        option.value = file;
                        option.textContent = file.replace(".txt", ""); // æ˜¾ç¤ºæ—¶å»æ‰åç¼€
                        selectElement.appendChild(option);
                    });
                    loadBtn.disabled = false;
                })
                .catch(err => {
                    selectElement.innerHTML = `<option value=''>-- åŠ è½½å¤±è´¥ï¼š${err.message} --</option>`;
                    loadBtn.disabled = true;
                    alert("åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥ï¼š" + err.message);
                });
        }

        /**
         * åŠ è½½é€‰ä¸­çš„æœåŠ¡å™¨è¯¾ç¨‹æ–‡ä»¶ï¼ˆè§£æTXTå†…å®¹ï¼‰
         */
        function loadSelectedCourse() {
            const selectElement = document.getElementById("courseFileSelect");
            const selectedFile = selectElement.value;
            if (!selectedFile) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯¾ç¨‹æ–‡ä»¶ï¼");
                return;
            }

            // è¯·æ±‚æœåŠ¡å™¨ä¸Šçš„TXTè¯¾ç¨‹æ–‡ä»¶
            fetch(SERVER_COURSE_DIR + selectedFile)
                .then(res => {
                    if (!res.ok) throw new Error("æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®");
                    return res.text();
                })
                .then(txtContent => {
                    // è§£æTXTå†…å®¹ï¼ˆæŒ‰çº¦å®šæ ¼å¼ï¼šç¬¬1è¡Œè¯¾ç¨‹åï¼Œç¬¬2è¡Œå¼€å§‹æ—¥æœŸï¼Œç¬¬3è¡Œèµ·å•è¯ï¼‰
                    const lines = txtContent.split('\n').map(line => line.trim()).filter(line => line);
                    if (lines.length < 2) {
                        throw new Error("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šè‡³å°‘éœ€åŒ…å«è¯¾ç¨‹åå’Œå¼€å§‹æ—¥æœŸ");
                    }

                    const courseName = lines[0];
                    const startDate = lines[1];
                    // éªŒè¯å¼€å§‹æ—¥æœŸæ ¼å¼
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
                        throw new Error("å¼€å§‹æ—¥æœŸæ ¼å¼é”™è¯¯ï¼šéœ€ä¸º YYYY-MM-DDï¼ˆå¦‚ 2024-10-06ï¼‰");
                    }

                    // è§£æå•è¯ï¼ˆç¬¬3è¡Œèµ·ï¼‰
                    const words = [];
                    for (let i = 2; i < lines.length; i++) {
                        const [eng, ...cnParts] = lines[i].split(' ');
                        const cn = cnParts.join(' ').trim();
                        if (eng && cn) {
                            words.push({ eng, cn });
                        }
                    }

                    // ç”Ÿæˆè¯¾ç¨‹è®¡åˆ’
                    const startDateObj = new Date(startDate);
                    startDateObj.setHours(0, 0, 0, 0);
                    const newCourse = {
                        id: Date.now(),
                        fileName: selectedFile,
                        name: courseName,
                        startDate: startDate,
                        words: words,
                        reviews: reviewIntervals.map((daysFromStart, i) => {
                            const reviewDate = new Date(startDateObj);
                            reviewDate.setDate(reviewDate.getDate() + daysFromStart);
                            return {
                                times: i + 1,
                                date: getLocalDateStr(reviewDate),
                                interval: daysFromStart
                            };
                        })
                    };

                    // æ›´æ–°å½“å‰è¯¾ç¨‹åˆ—è¡¨ï¼ˆå»é‡ï¼šåŒä¸€æ–‡ä»¶ä¸é‡å¤åŠ è½½ï¼‰
                    currentCourses = currentCourses.filter(course => course.fileName !== selectedFile);
                    currentCourses.push(newCourse);
                    // åˆ·æ–°é¡µé¢æ˜¾ç¤º
                    renderCoursePlans();
                    alert(`æˆåŠŸåŠ è½½è¯¾ç¨‹ï¼š${courseName}`);
                })
                .catch(err => {
                    alert("åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼š" + err.message);
                });
        }

        /**
         * æ¸²æŸ“è¯¾ç¨‹è®¡åˆ’ï¼ˆå«å•è¯¾ç¨‹å¯¼å‡ºæŒ‰é’®ï¼‰
         */
        function renderCoursePlans() {
            const allPlansContainer = document.getElementById("allPlans");
            allPlansContainer.innerHTML = "";

            if (currentCourses.length === 0) {
                allPlansContainer.innerHTML = `<p class="no-today">æš‚æ— åŠ è½½çš„è¯¾ç¨‹è®¡åˆ’ï¼Œè¯·é€‰æ‹©å¹¶åŠ è½½æœåŠ¡å™¨è¯¾ç¨‹æ–‡ä»¶</p>`;
                updateTodayReviewList();
                return;
            }

            // æ›´æ–°ä»Šæ—¥å¤ä¹ åˆ—è¡¨
            updateTodayReviewList();

            // æ¸²æŸ“æ¯ä¸ªè¯¾ç¨‹è®¡åˆ’ï¼ˆæ–°å¢ã€Œå¯¼å‡ºæœ¬è¯¾ç¨‹ã€æŒ‰é’®ï¼‰
            currentCourses.forEach(course => {
                const planItem = document.createElement("div");
                planItem.className = "plan-item";

                // æ¸²æŸ“å¤ä¹ æ—¥æœŸï¼ˆæ ‡è®°ä»Šæ—¥/å·²è¿‡æœŸï¼‰
                let reviewHtml = "";
                course.reviews.forEach(review => {
                    const isToday = review.date === todayStr;
                    const isPast = new Date(review.date) < today;
                    let statusStyle = "";
                    if (isToday) statusStyle = "color:#e67e22;font-weight:bold";
                    if (isPast) statusStyle = "color:#6c757d;text-decoration:line-through";
                    reviewHtml += `<div class="review-day"><span style="${statusStyle}">ç¬¬${review.times}æ¬¡ï¼š${review.date}</span>ï¼ˆè·å¼€å§‹ç¬¬${review.interval}å¤©ï¼‰</div>`;
                });

                // æ¸²æŸ“å•è¯ä¿¡æ¯
                let wordHtml = "";
                if (course.words.length > 0) {
                    wordHtml = `<div class="tip">å•è¯åˆ—è¡¨ï¼ˆå…±${course.words.length}ä¸ªï¼‰ï¼š<br>${course.words.map(w => `â€¢ ${w.eng} - ${w.cn}`).join('<br>')}</div>`;
                } else {
                    wordHtml = `<div class="tip">æœ¬è¯¾ç¨‹æœªæ·»åŠ å•è¯</div>`;
                }

                // æ–°å¢ã€Œå¯¼å‡ºæœ¬è¯¾ç¨‹ã€æŒ‰é’®
                planItem.innerHTML = `
                    <div class="title">ğŸ“š ${course.name}ï¼ˆæ–‡ä»¶ï¼š${course.fileName} | å¼€å§‹æ—¥æœŸï¼š${course.startDate}ï¼‰</div>
                    <div>${reviewHtml}</div>
                    ${wordHtml}
                    <button onclick="exportSingleCourse(${course.id})" style="margin-top:10px;">å¯¼å‡ºæœ¬è¯¾ç¨‹è®¡åˆ’</button>
                `;
                allPlansContainer.appendChild(planItem);
            });
        }

        /**
         * å•è¯¾ç¨‹å¯¼å‡ºï¼ˆä»…å¯¼å‡ºé€‰ä¸­çš„å•ä¸ªè¯¾ç¨‹ï¼‰
         */
        function exportSingleCourse(courseId) {
            const course = currentCourses.find(c => c.id === courseId);
            if (!course) {
                alert("æœªæ‰¾åˆ°è¯¥è¯¾ç¨‹ï¼Œæ— æ³•å¯¼å‡ºï¼");
                return;
            }

            // æ„å»ºå¯¼å‡ºå†…å®¹
            let txtContent = `=== è‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’ - ${course.name} ===\n`;
            txtContent += `è¯¾ç¨‹æ–‡ä»¶ï¼š${course.fileName}\n`;
            txtContent += `å¼€å§‹æ—¥æœŸï¼š${course.startDate}\n`;
            txtContent += `å¯¼å‡ºæ—¥æœŸï¼š${new Date().toLocaleDateString()}\n\n`;

            txtContent += `10æ¬¡å¤ä¹ å®‰æ’ï¼š\n`;
            course.reviews.forEach(review => {
                txtContent += `  ç¬¬${review.times}æ¬¡ï¼š${review.date}ï¼ˆè·å¼€å§‹ç¬¬${review.interval}å¤©ï¼‰\n`;
            });

            if (course.words.length > 0) {
                txtContent += `\nå•è¯åˆ—è¡¨ï¼š\n`;
                course.words.forEach(word => {
                    txtContent += `  ${word.eng} ${word.cn}\n`;
                });
            } else {
                txtContent += `\nå•è¯åˆ—è¡¨ï¼šæ— \n`;
            }

            // ä¸‹è½½TXTæ–‡ä»¶
            const blob = new Blob([txtContent], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            const exportFileName = `${course.name}_å¤ä¹ è®¡åˆ’_${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
            a.href = url;
            a.download = exportFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`å·²æˆåŠŸå¯¼å‡ºè¯¾ç¨‹ï¼šã€Š${course.name}ã€‹`);
        }

        /**
         * æ›´æ–°ä»Šæ—¥å¤ä¹ åˆ—è¡¨
         */
        function updateTodayReviewList() {
            const todayReviewList = document.getElementById("todayReviewList");
            const todayCourses = currentCourses.filter(course => 
                course.reviews.some(review => review.date === todayStr)
            );

            if (todayCourses.length === 0) {
                todayReviewList.innerHTML = "ä»Šæ—¥æš‚æ— å¤ä¹ ä»»åŠ¡ï¼Œå¥½å¥½ä¼‘æ¯å§ï¼";
                todayReviewList.className = "no-today";
                return;
            }

            todayReviewList.className = "";
            let todayHtml = "";
            todayCourses.forEach(course => {
                const reviewTimes = course.reviews.find(r => r.date === todayStr).times;
                todayHtml += `<div class="today-item">â€¢ ${course.name}ï¼ˆç¬¬${reviewTimes}æ¬¡å¤ä¹ ï¼‰</div>`;
            });
            todayReviewList.innerHTML = todayHtml;
        }
    </script>
</body>
</html>
